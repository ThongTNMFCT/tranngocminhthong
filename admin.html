<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trang Quản Trị</title>
    <link rel="icon" href="https://placehold.co/32x32/64ffda/0a192f?text=A" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Fira Code', monospace; background-color: #0a192f; color: #a8b2d1; }
        .form-container, .panel-container, .modal-content { background-color: #112240; border: 1px solid #233554; }
        .form-input, select.form-input {
            background-color: #233554; border: 1px solid #495670; color: #ccd6f6;
            font-family: inherit;
        }
        .form-input:focus, select.form-input:focus {
            outline: none; border-color: #64ffda;
            box-shadow: 0 0 0 2px rgba(100, 255, 218, 0.2);
        }
        .btn-primary { background-color: #64ffda; color: #0a192f; font-weight: bold; }
        .btn-primary:hover { background-color: #52d1b8; }
        .btn-danger { background-color: #e57373; color: #0a192f; font-weight: bold; }
        .btn-danger:hover { background-color: #ef5350; }
        .tab-button.active { border-color: #64ffda; color: #64ffda; }
        .editor-container { border: 1px solid #495670; border-radius: 0.375rem; overflow: hidden; }
        .editor-toolbar { background-color: #112240; border-bottom: 1px solid #495670; padding: 0.5rem; display: flex; gap: 0.5rem;}
        .editor-toolbar button { background-color: #233554; border: 1px solid #495670; color: #a8b2d1; padding: 0.25rem 0.75rem; border-radius: 0.25rem; }
        .editor-content {
            background-color: #233554; outline: none; min-height: 250px; padding: 0.75rem; color: #ccd6f6;
            font-family: inherit;
        }
        .editor-content img { max-width: 100%; height: auto; border-radius: 4px; margin: 0.5rem 0; }
        .manage-item { background-color: #233554; border: 1px solid #495670; }
    </style>
</head>
<body>

    <div id="login-container" class="min-h-screen flex items-center justify-center p-4">
        <div class="form-container p-8 rounded-lg shadow-md w-full max-w-sm">
            <h2 class="text-2xl font-bold text-center text-gray-200 mb-6">Đăng Nhập Quản Trị</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="email" class="block text-gray-400 mb-2">Email</label>
                    <input type="email" id="email" class="form-input w-full px-3 py-2 rounded-md" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-gray-400 mb-2">Mật khẩu</label>
                    <input type="password" id="password" class="form-input w-full px-3 py-2 rounded-md" required>
                </div>
                <button type="submit" class="btn-primary w-full py-2 px-4 rounded-md transition-colors">Đăng Nhập</button>
            </form>
            <p id="login-error" class="text-red-400 text-center mt-4"></p>
        </div>
    </div>

    <div id="admin-panel" class="hidden">
        <header class="bg-[#0a192f] shadow-md border-b border-[#233554]">
            <div class="container mx-auto px-6 py-4 flex justify-between items-center">
                <h1 class="text-xl font-bold text-gray-200">Bảng điều khiển</h1>
                <button id="logout-btn" class="btn-danger py-2 px-4 rounded-md transition-colors text-sm">Đăng xuất</button>
            </div>
        </header>

        <main class="container mx-auto px-6 py-8">
            <div class="mb-6 border-b border-slate-700">
                <nav class="flex space-x-4 overflow-x-auto">
                    <button data-tab="post" class="tab-button py-2 px-4 text-slate-400 font-medium border-b-2 border-transparent hover:border-cyan-400 hover:text-cyan-400 transition-colors active whitespace-nowrap">Bài Viết</button>
                    <button data-tab="achievement" class="tab-button py-2 px-4 text-slate-400 font-medium border-b-2 border-transparent hover:border-cyan-400 hover:text-cyan-400 transition-colors whitespace-nowrap">Thành Tích</button>
                    <button data-tab="project" class="tab-button py-2 px-4 text-slate-400 font-medium border-b-2 border-transparent hover:border-cyan-400 hover:text-cyan-400 transition-colors whitespace-nowrap">Dự án</button>
                    <button data-tab="event" class="tab-button py-2 px-4 text-slate-400 font-medium border-b-2 border-transparent hover:border-cyan-400 hover:text-cyan-400 transition-colors whitespace-nowrap">Sự kiện</button>
                    <button data-tab="manage" class="tab-button py-2 px-4 text-slate-400 font-medium border-b-2 border-transparent hover:border-cyan-400 hover:text-cyan-400 transition-colors whitespace-nowrap">Quản lý</button>
                </nav>
            </div>

            <div id="sections-container">
                <div id="post-section" class="tab-content panel-container p-8 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-200" id="post-form-title">Thêm bài viết mới</h2>
                        <button data-type="post" class="cancel-edit-btn hidden text-sm text-slate-400 hover:text-cyan-400">Hủy sửa</button>
                    </div>
                    <div class="space-y-6">
                        <input type="hidden" id="editing-post-id">
                        <div>
                            <label for="post-title" class="block font-medium mb-2">Tiêu đề bài viết</label>
                            <input type="text" id="post-title" class="form-input w-full px-3 py-2">
                        </div>
                        <div>
                            <label for="post-image" class="block font-medium mb-2">Ảnh bìa (cho danh sách)</label>
                            <input type="file" id="post-image" accept="image/*" class="w-full file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-[#233554] file:text-[#64ffda] hover:file:bg-[#495670]">
                        </div>
                        <div>
                            <label class="block font-medium mb-2">Nội dung (hỗ trợ dán ảnh)</label>
                            <div class="editor-container">
                                <div class="editor-toolbar" data-editor-id="post-content">
                                    <button data-command="bold"><b>B</b></button>
                                    <button data-command="italic"><i>I</i></button>
                                    <button data-command="underline"><u>U</u></button>
                                </div>
                                <div id="post-content" contenteditable="true" class="editor-content"></div>
                            </div>
                        </div>
                        <button id="save-post-btn" class="w-full sm:w-auto btn-primary py-2 px-6 rounded-md transition-colors">Đăng bài</button>
                    </div>
                </div>

                <div id="achievement-section" class="tab-content hidden panel-container p-8 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-200" id="achievement-form-title">Thêm thành tích mới</h2>
                        <button data-type="achievement" class="cancel-edit-btn hidden text-sm text-slate-400 hover:text-cyan-400">Hủy sửa</button>
                    </div>
                     <div class="space-y-6">
                        <input type="hidden" id="editing-achievement-id">
                        <div>
                            <label for="achievement-title" class="block font-medium mb-2">Tên thành tích</label>
                            <input type="text" id="achievement-title" class="form-input w-full px-3 py-2">
                        </div>
                         <div>
                            <label for="achievement-images" class="block font-medium mb-2">Ảnh minh chứng (chọn nhiều ảnh)</label>
                            <input type="file" id="achievement-images" accept="image/*" multiple class="w-full file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-[#233554] file:text-[#64ffda] hover:file:bg-[#495670]">
                        </div>
                        <div>
                            <label class="block font-medium mb-2">Nội dung mô tả (hỗ trợ dán ảnh)</label>
                            <div class="editor-container">
                                <div class="editor-toolbar" data-editor-id="achievement-content">
                                    <button data-command="bold"><b>B</b></button>
                                    <button data-command="italic"><i>I</i></button>
                                    <button data-command="underline"><u>U</u></button>
                                </div>
                                <div id="achievement-content" contenteditable="true" class="editor-content"></div>
                            </div>
                        </div>
                        <button id="save-achievement-btn" class="w-full sm:w-auto btn-primary py-2 px-6 rounded-md transition-colors">Lưu thành tích</button>
                    </div>
                </div>
                
                <div id="project-section" class="tab-content hidden panel-container p-8 rounded-lg shadow-md">
                     <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-200" id="project-form-title">Thêm dự án mới</h2>
                        <button data-type="project" class="cancel-edit-btn hidden text-sm text-slate-400 hover:text-cyan-400">Hủy sửa</button>
                    </div>
                     <div class="space-y-6">
                        <input type="hidden" id="editing-project-id">
                        <div>
                            <label for="project-title" class="block font-medium mb-2">Tên dự án</label>
                            <input type="text" id="project-title" class="form-input w-full px-3 py-2">
                        </div>
                         <div>
                            <label for="project-images" class="block font-medium mb-2">Ảnh dự án (chọn nhiều ảnh)</label>
                            <input type="file" id="project-images" accept="image/*" multiple class="w-full file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-[#233554] file:text-[#64ffda] hover:file:bg-[#495670]">
                        </div>
                        <div>
                            <label class="block font-medium mb-2">Nội dung mô tả (hỗ trợ dán ảnh)</label>
                            <div class="editor-container">
                                <div class="editor-toolbar" data-editor-id="project-content">
                                    <button data-command="bold"><b>B</b></button>
                                    <button data-command="italic"><i>I</i></button>
                                    <button data-command="underline"><u>U</u></button>
                                </div>
                                <div id="project-content" contenteditable="true" class="editor-content"></div>
                            </div>
                        </div>
                        <button id="save-project-btn" class="w-full sm:w-auto btn-primary py-2 px-6 rounded-md transition-colors">Lưu dự án</button>
                    </div>
                </div>
                
                <div id="event-section" class="tab-content hidden panel-container p-8 rounded-lg shadow-md">
                     <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-200" id="event-form-title">Thêm sự kiện mới</h2>
                        <button data-type="event" class="cancel-edit-btn hidden text-sm text-slate-400 hover:text-cyan-400">Hủy sửa</button>
                    </div>
                    <div class="space-y-6">
                        <input type="hidden" id="editing-event-id">
                        <div>
                            <label for="event-title" class="block font-medium mb-2">Tên sự kiện</label>
                            <input type="text" id="event-title" class="form-input w-full px-3 py-2">
                        </div>
                        <div>
                            <label for="event-date" class="block font-medium mb-2">Ngày diễn ra</label>
                            <input type="date" id="event-date" class="form-input w-full px-3 py-2">
                        </div>
                        <div>
                            <label for="event-image" class="block font-medium mb-2">Ảnh bìa (cho danh sách)</label>
                            <input type="file" id="event-image" accept="image/*" class="w-full file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-[#233554] file:text-[#64ffda] hover:file:bg-[#495670]">
                        </div>
                        <div>
                            <label class="block font-medium mb-2">Nội dung (hỗ trợ dán ảnh)</label>
                            <div class="editor-container">
                                <div class="editor-toolbar" data-editor-id="event-content">
                                    <button data-command="bold"><b>B</b></button>
                                    <button data-command="italic"><i>I</i></button>
                                    <button data-command="underline"><u>U</u></button>
                                </div>
                                <div id="event-content" contenteditable="true" class="editor-content"></div>
                            </div>
                        </div>
                        <button id="save-event-btn" class="w-full sm:w-auto btn-primary py-2 px-6 rounded-md transition-colors">Lưu sự kiện</button>
                    </div>
                </div>

                <div id="manage-section" class="tab-content hidden panel-container p-8 rounded-lg shadow-md">
                    <h2 class="text-2xl font-bold text-gray-200 mb-6">Quản lý nội dung</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-4 gap-8">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-300 mb-4 border-b border-slate-700 pb-2">Bài viết</h3>
                            <div id="manage-posts-list" class="space-y-3 max-h-96 overflow-y-auto pr-2"></div>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-300 mb-4 border-b border-slate-700 pb-2">Thành tích</h3>
                            <div id="manage-achievements-list" class="space-y-3 max-h-96 overflow-y-auto pr-2"></div>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-300 mb-4 border-b border-slate-700 pb-2">Dự án</h3>
                            <div id="manage-projects-list" class="space-y-3 max-h-96 overflow-y-auto pr-2"></div>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-300 mb-4 border-b border-slate-700 pb-2">Sự kiện</h3>
                            <div id="manage-events-list" class="space-y-3 max-h-96 overflow-y-auto pr-2"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
        <div class="modal-content rounded-lg shadow-xl p-6 w-full max-w-md">
            <h3 class="text-xl font-bold text-gray-200">Xác nhận xóa</h3>
            <p class="text-gray-400 mt-2 mb-6">Bạn có chắc chắn muốn xóa mục này không? Hành động này không thể hoàn tác.</p>
            <div class="flex justify-end space-x-4">
                <button id="cancel-delete-btn" class="px-6 py-2 rounded-md bg-[#233554] hover:bg-[#495670] transition">Hủy</button>
                <button id="confirm-delete-btn" class="px-6 py-2 rounded-md btn-danger transition">Xóa</button>
            </div>
        </div>
    </div>
    
    <div id="notification" class="hidden fixed bottom-5 right-5 bg-gray-200 text-gray-900 py-3 px-6 rounded-lg shadow-lg"></div>

    <script type="module">
        import { firebaseConfig, IMGBB_API_KEY } from './firebase-key.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, getDocs, query, orderBy, doc, deleteDoc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- GLOBAL STATE ---
        let docToDelete = { id: null, collection: null };

        // --- DOM Elements ---
        const loginContainer = document.getElementById('login-container');
        const adminPanel = document.getElementById('admin-panel');
        const loginForm = document.getElementById('login-form');
        const logoutBtn = document.getElementById('logout-btn');
        const notification = document.getElementById('notification');
        const deleteModal = document.getElementById('delete-modal');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');

        // --- UTILITY FUNCTIONS ---
        function showNotification(message, isError = false) {
            notification.textContent = message;
            notification.classList.remove('hidden');
            notification.style.backgroundColor = isError ? '#e57373' : '#64ffda';
            notification.style.color = '#0a192f';
            setTimeout(() => { notification.classList.add('hidden'); }, 3000);
        }

        async function uploadImageToImgBB(file) {
            if (!IMGBB_API_KEY || IMGBB_API_KEY === 'YOUR_IMGBB_API_KEY_HERE') {
                const errorMsg = "Lỗi: IMGBB_API_KEY chưa được cấu hình trong firebase-key.js";
                showNotification(errorMsg, true); return null;
            }
            const formData = new FormData();
            formData.append('image', file);
            try {
                const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: 'POST', body: formData });
                const result = await response.json();
                if (result.success) return result.data.url;
                throw new Error(result.error.message || `Lỗi không xác định từ ImgBB (Status: ${response.status})`);
            } catch (error) {
                console.error('ImgBB Upload Error:', error);
                showNotification(error.message, true); return null;
            }
        }
        
        // ** FUNCTION TO INSERT CONTENT AT CURSOR (FIXED FOR PASTE) **
        function insertContent(html) {
            const selection = window.getSelection();
            if (!selection.rangeCount) return;
            const range = selection.getRangeAt(0);
            range.deleteContents();
            const tempDiv = document.createElement("div");
            tempDiv.innerHTML = html;
            const frag = document.createDocumentFragment();
            let node;
            while ((node = tempDiv.firstChild)) {
                frag.appendChild(node);
            }
            const lastNode = frag.lastChild;
            range.insertNode(frag);
            // Move cursor to the end of the inserted content
            if (lastNode) {
                const newRange = range.cloneRange();
                newRange.setStartAfter(lastNode);
                newRange.collapse(true);
                selection.removeAllRanges();
                selection.addRange(newRange);
            }
        }

        // --- RICH TEXT EDITOR ENHANCEMENTS ---
        function setupEditor(editorId) {
            const editor = document.getElementById(editorId);
            if (!editor) return;

            const toolbar = document.querySelector(`.editor-toolbar[data-editor-id="${editorId}"]`);
            if (toolbar) {
                toolbar.addEventListener('click', e => {
                    const command = e.target.closest('button')?.dataset.command;
                    if (command) { e.preventDefault(); document.execCommand(command, false, null); editor.focus(); }
                });
            }

            editor.addEventListener('paste', async (e) => {
                e.preventDefault();
                const clipboardData = e.clipboardData || window.clipboardData;
                const items = clipboardData.items;
                let imageFound = false;
                if(items) {
                    for (const item of items) {
                        if (item.type.includes('image')) {
                            const file = item.getAsFile();
                            if (file) {
                                imageFound = true;
                                const placeholderId = `uploading-${Date.now()}`;
                                insertContent(`<p id="${placeholderId}">[Đang tải ảnh lên...]</p>`);
                                
                                const imageUrl = await uploadImageToImgBB(file);
                                const placeholder = editor.querySelector(`#${placeholderId}`);
                                if (imageUrl && placeholder) {
                                    const img = document.createElement('img');
                                    img.src = imageUrl;
                                    placeholder.parentNode.replaceChild(img, placeholder);
                                } else if (placeholder) {
                                    placeholder.textContent = '[Lỗi tải ảnh!]';
                                }
                            }
                        }
                    }
                }
                if (!imageFound) {
                    const text = clipboardData.getData('text/plain');
                    // Replace newlines with <br> tags to preserve line breaks
                    const html = text.replace(/(?:\r\n|\r|\n)/g, '<br>');
                    insertContent(html);
                }
            });
        }

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, user => {
            loginContainer.classList.toggle('hidden', !!user);
            adminPanel.classList.toggle('hidden', !user);
            if (user) {
                ['post', 'achievement', 'project', 'event'].forEach(type => setupEditor(`${type}-content`));
            }
        });
        loginForm.addEventListener('submit', async e => {
            e.preventDefault();
            try {
                await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value);
            } catch (error) { document.getElementById('login-error').textContent = 'Email hoặc mật khẩu không đúng.'; }
        });
        logoutBtn.addEventListener('click', () => signOut(auth));

        // --- TAB SWITCHING ---
        document.querySelector('.tab-button[data-tab="post"]').classList.add('active');
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                const tab = button.dataset.tab;
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                document.getElementById(`${tab}-section`).classList.remove('hidden');
                if (tab === 'manage') loadAllListsForManagement();
            });
        });

        // --- FORM RESET & EDIT MODE ---
        function resetForm(type) {
            document.getElementById(`${type}-form-title`).textContent = `Thêm ${type} mới`;
            document.querySelector(`#save-${type}-btn`).textContent = `Lưu ${type}`;
            document.querySelector(`button.cancel-edit-btn[data-type="${type}"]`).classList.add('hidden');
            const formIds = [`editing-${type}-id`, `${type}-title`, `${type}-content`];
            if (document.getElementById(`${type}-image`)) formIds.push(`${type}-image`);
            if (document.getElementById(`${type}-images`)) formIds.push(`${type}-images`);
            if (document.getElementById(`${type}-date`)) formIds.push(`${type}-date`);
            formIds.forEach(id => {
                const el = document.getElementById(id);
                if (el.tagName === 'INPUT' || el.tagName === 'SELECT') el.value = '';
                else el.innerHTML = '';
            });
        }
        document.querySelectorAll('.cancel-edit-btn').forEach(btn => btn.addEventListener('click', () => resetForm(btn.dataset.type)));

        async function startEdit(collectionName, id) {
            const type = collectionName.slice(0, -1);
            const docRef = doc(db, collectionName, id);
            const docSnap = await getDoc(docRef);
            if (!docSnap.exists()) { showNotification("Không tìm thấy mục để sửa!", true); return; }
            const data = docSnap.data();
            
            document.querySelector(`.tab-button[data-tab="${type}"]`).click();
            
            document.getElementById(`editing-${type}-id`).value = id;
            document.getElementById(`${type}-form-title`).textContent = `Sửa ${type}`;
            document.querySelector(`#save-${type}-btn`).textContent = 'Cập nhật';
            document.querySelector(`button.cancel-edit-btn[data-type="${type}"]`).classList.remove('hidden');
            
            document.getElementById(`${type}-title`).value = data.title;
            const editor = document.getElementById(`${type}-content`);
            editor.innerHTML = data.content || '';
            if (document.getElementById(`${type}-date`)) document.getElementById(`${type}-date`).value = data.eventDate || '';
            editor.focus();
        }

        // --- SAVE/UPDATE LOGIC ---
        async function saveData(type) {
            const collectionName = `${type}s`;
            const id = document.getElementById(`editing-${type}-id`).value;
            const title = document.getElementById(`${type}-title`).value;
            const content = document.getElementById(`${type}-content`).innerHTML;
            
            if (!title) { showNotification("Vui lòng nhập tiêu đề.", true); return; }

            let data = { title, content };
            if (!id) data.timestamp = serverTimestamp();

            if (type === 'event') data.eventDate = document.getElementById('event-date').value;

            document.querySelector(`#save-${type}-btn`).disabled = true;

            if (type === 'post' || type === 'event') {
                const imageFile = document.getElementById(`${type}-image`).files[0];
                if (imageFile) {
                    const imageUrl = await uploadImageToImgBB(imageFile);
                    if (imageUrl) data.imageUrl = imageUrl;
                    else { document.querySelector(`#save-${type}-btn`).disabled = false; return; }
                }
            } else if (type === 'achievement' || type === 'project') {
                const imageFiles = document.getElementById(`${type}-images`).files;
                if (imageFiles.length > 0) {
                    const urls = await Promise.all( Array.from(imageFiles).map(file => uploadImageToImgBB(file)) );
                    data.imageUrls = urls.filter(url => url !== null);
                }
            }

            try {
                if (id) {
                    await updateDoc(doc(db, collectionName, id), data);
                    showNotification("Cập nhật thành công!");
                } else {
                    await addDoc(collection(db, collectionName), data);
                    showNotification("Lưu thành công!");
                }
                resetForm(type);
                if (document.querySelector('.tab-button[data-tab="manage"]').classList.contains('active')) {
                    renderListForManagement(collectionName);
                }
            } catch (error) {
                console.error("Save/Update Error:", error);
                showNotification("Có lỗi xảy ra!", true);
            } finally {
                document.querySelector(`#save-${type}-btn`).disabled = false;
            }
        }
        
        document.getElementById('save-post-btn').addEventListener('click', () => saveData('post'));
        document.getElementById('save-achievement-btn').addEventListener('click', () => saveData('achievement'));
        document.getElementById('save-project-btn').addEventListener('click', () => saveData('project'));
        document.getElementById('save-event-btn').addEventListener('click', () => saveData('event'));

        // --- MANAGEMENT LOGIC ---
        async function renderListForManagement(collectionName) {
            const container = document.getElementById(`manage-${collectionName}-list`);
            container.innerHTML = '<p>Đang tải...</p>';
            try {
                const q = query(collection(db, collectionName), orderBy('timestamp', 'desc'));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) { container.innerHTML = '<p class="text-slate-500">Chưa có nội dung.</p>'; return; }
                
                container.innerHTML = '';
                querySnapshot.forEach((doc) => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'manage-item flex justify-between items-center p-2 rounded-md';
                    itemEl.innerHTML = `
                        <span class="truncate pr-2">${doc.data().title}</span>
                        <div class="flex-shrink-0 space-x-2">
                           <button data-id="${doc.id}" data-collection="${collectionName}" class="edit-btn text-cyan-400 hover:text-cyan-200 font-semibold">Sửa</button>
                           <button data-id="${doc.id}" data-collection="${collectionName}" class="delete-btn text-red-400 hover:text-red-200 font-semibold">Xóa</button>
                        </div>
                    `;
                    container.appendChild(itemEl);
                });

                container.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', () => {
                    docToDelete = { id: btn.dataset.id, collection: btn.dataset.collection };
                    deleteModal.classList.remove('hidden');
                }));
                
                container.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', () => {
                   startEdit(btn.dataset.collection, btn.dataset.id);
                }));

            } catch (error) {
                console.error(`Error loading ${collectionName}:`, error);
                container.innerHTML = `<p class="text-red-500">Lỗi khi tải danh sách.</p>`;
            }
        }

        function loadAllListsForManagement() {
            renderListForManagement('posts');
            renderListForManagement('achievements');
            renderListForManagement('projects');
            renderListForManagement('events');
        }

        // --- DELETE MODAL LOGIC ---
        cancelDeleteBtn.addEventListener('click', () => deleteModal.classList.add('hidden'));
        confirmDeleteBtn.addEventListener('click', async () => {
            if (!docToDelete.id) return;
            try {
                await deleteDoc(doc(db, docToDelete.collection, docToDelete.id));
                showNotification('Xóa thành công!');
                renderListForManagement(docToDelete.collection);
            } catch (error) {
                showNotification('Có lỗi xảy ra khi xóa.', true);
            } finally {
                deleteModal.classList.add('hidden');
            }
        });
    </script>
</body>
</html>
